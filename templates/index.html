<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Rating System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-gray-100">
    <div x-data="imageRating()" class="container mx-auto p-4 flex">
        <div class="w-3/4 pr-4">
            <h1 class="text-3xl font-bold mb-4">Image Rating System</h1>
            
            <div class="mb-4">
                <label for="modelFilter" class="mr-2">Model:</label>
                <select id="modelFilter" x-model="modelFilter" class="p-2 border rounded">
                    <option value="">All Models</option>
                    <template x-for="model in models">
                        <option :value="model" x-text="model"></option>
                    </template>
                </select>
                
                <label for="promptTypeFilter" class="ml-4 mr-2">Prompt Type:</label>
                <select id="promptTypeFilter" x-model="promptTypeFilter" class="p-2 border rounded">
                    <option value="">All Types</option>
                    <template x-for="type in promptTypes">
                        <option :value="type" x-text="type"></option>
                    </template>
                </select>
                
                <label for="dreamFilter" class="ml-4 mr-2">Dream:</label>
                <select id="dreamFilter" x-model="dreamFilter" class="p-2 border rounded">
                    <option value="">All Dreams</option>
                    <template x-for="dream in dreams">
                        <option :value="dream" x-text="dream"></option>
                    </template>
                </select>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <template x-for="image in filteredImages" :key="image.filename">
                    <div class="bg-white p-4 rounded shadow">
                        <img :src="'/uploads/' + image.filename" :alt="image.filename" class="w-full h-48 object-cover mb-2">
                        <p><strong>Dream:</strong> <span x-text="image.dream"></span></p>
                        <p><strong>Model:</strong> <span x-text="image.model"></span></p>
                        <p><strong>Prompt:</strong> <span x-text="image.prompt"></span></p>
                        <p><strong>Generation Time:</strong> <span x-text="image.generation_time ? image.generation_time.toFixed(2) : 'N/A'"></span> seconds</p>
                        <div class="mt-2">
                            <label>Rating:</label>
                            <select :value="image.rating" @change="rateImage(image.filename, $event.target.value)" class="p-1 border rounded">
                                <option value="0">Not Rated</option>
                                <option value="1">1 Star</option>
                                <option value="2">2 Stars</option>
                                <option value="3">3 Stars</option>
                                <option value="4">4 Stars</option>
                                <option value="5">5 Stars</option>
                            </select>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        
        <div class="w-1/4 pl-4 sticky top-0 h-screen overflow-auto">
            <h2 class="text-2xl font-bold mb-2">Top Rated Models</h2>
            <ul>
                <template x-for="model in topModels" :key="model[0]">
                    <li class="mb-2">
                        <span x-text="model[0]" class="font-semibold"></span>: 
                        <span x-text="model[1] ? model[1].toFixed(2) : 'N/A'" class="text-blue-600"></span> stars
                    </li>
                </template>
            </ul>
        </div>
    </div>

    <script>
        function imageRating() {
            return {
                metadata: [],
                models: [],
                dreams: [],
                promptTypes: [],
                modelFilter: '',
                promptTypeFilter: '',
                dreamFilter: '',
                topModels: [],
                
                init() {
                    this.fetchData();
                },
                
                fetchData() {
                    fetch('/get_data')
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                console.error('Error fetching data:', data.error);
                                return;
                            }
                            this.metadata = data.metadata || [];
                            this.models = data.models || [];
                            this.dreams = data.dreams || [];
                            this.promptTypes = data.prompt_types || [];
                            this.updateTopModels();
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                },
                
                get filteredImages() {
                    return this.metadata.filter(image => 
                        (!this.modelFilter || image.model === this.modelFilter) &&
                        (!this.promptTypeFilter || (this.promptTypeFilter === 'POV' ? image.prompt.includes('POV') : !image.prompt.includes('POV'))) &&
                        (!this.dreamFilter || image.dream === this.dreamFilter)
                    );
                },
                
                rateImage(filename, rating) {
                    fetch('/rate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ filename, rating: parseInt(rating) }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const image = this.metadata.find(img => img.filename === filename);
                            if (image) {
                                image.rating = parseInt(rating);
                            }
                            this.updateTopModels();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                },
                
                updateTopModels() {
                    // Calculate top models locally to update in real-time
                    const modelRatings = {};
                    this.metadata.forEach(image => {
                        if (image.rating > 0) {
                            if (!modelRatings[image.model]) {
                                modelRatings[image.model] = { sum: 0, count: 0 };
                            }
                            modelRatings[image.model].sum += image.rating;
                            modelRatings[image.model].count += 1;
                        }
                    });
                    
                    this.topModels = Object.entries(modelRatings)
                        .map(([model, data]) => [model, data.sum / data.count])
                        .sort((a, b) => b[1] - a[1]);
                }
            }
        }
    </script>
</body>
</html>